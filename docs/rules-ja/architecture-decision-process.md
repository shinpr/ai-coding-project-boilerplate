# アーキテクチャ決定プロセス

## 目的

このドキュメントは、本プロジェクトにおけるアーキテクチャ決定のプロセスを定義し、一貫性のある技術的意思決定を行うためのガイドラインを提供します。

## アーキテクチャ決定が必要なケース

### 必須となるケース

以下の変更を行う場合は、**実装前に**必ずADRの作成とレビューが必要です：

1. **型システムの変更**
   - 新しい型階層の導入
   - 既存の主要な型定義の削除・統合
   - 型の責務や役割の変更

2. **データフローの変更**
   - データの保存場所の変更
   - 処理フローの大幅な変更
   - コンポーネント間のデータ受け渡し方法の変更

3. **アーキテクチャレベルの変更**
   - 新しいレイヤーやモジュールの追加
   - 既存レイヤーの責務変更
   - 主要コンポーネントの再配置

4. **大規模な変更**
   - 5ファイル以上に影響する変更
   - 複数のコンポーネントにまたがる変更

5. **外部依存関係**
   - 新しいライブラリやフレームワークの導入
   - 既存の外部依存の削除や置き換え
   - 外部APIの統合方法の変更

### 推奨されるケース

以下の場合もADRの作成を推奨します：

- パフォーマンスクリティカルな実装の変更
- セキュリティに関わる設計変更
- 将来の拡張性に大きく影響する決定

## プロセスの流れ

### 1. 問題の識別と分析

**実施内容**：
- 解決すべき問題の明確化
- 現状の課題と制約の整理
- 影響範囲の特定

**成果物**：
- 問題定義ドキュメント（ADRのコンテキスト部分）

### 2. 選択肢の検討

**実施内容**：
- 複数の解決策の洗い出し
- 各選択肢の利点・欠点の分析
- トレードオフの明確化

**成果物**：
- 選択肢比較表

### 3. ADR作成

**実施内容**：
- `docs/adr/template.md`を使用してADRを作成
- 決定事項と根拠を明確に記述
- 実装ガイドラインを含める

**命名規則**：
- ファイル名: `ADR-[番号]-[短いタイトル].md`
- 例: `ADR-0001-deepresearch-data-flow-unification.md`

**番号採番ルール**：
- 4桁の連番形式（0001, 0002, 0003...）
- 既存のADRの最大番号 + 1を使用
- 番号の再利用は禁止（削除されたADRの番号も使用しない）

### 4. レビューと承認

**レビュー観点**：
- 問題定義の妥当性
- 選択肢の網羅性
- 決定の合理性
- 実装可能性
- プロジェクト全体との整合性

**承認プロセス**：
1. AI（LLM）がADRのドラフトを作成
2. ユーザーに提示してレビュー依頼
3. 必要に応じて修正
4. ユーザーの承認後、ステータスを"Accepted"に更新

**役割の定義**：
- **ADR作成者**: AI（Claude等のLLM）
- **承認者**: ユーザー（プロジェクトオーナー）
- このプロジェクトでは、すべてのADRはユーザーの承認が必要

### 5. 実装

**実装時の注意事項**：
- ADRの実装ガイドラインに従う
- 大きな逸脱がある場合はADRを更新
- 実装中に発見した問題は記録

### 6. 振り返りと更新

**実施内容**：
- 実装後の結果を評価
- 想定外の影響があれば記録
- 必要に応じてADRを更新

## ADRのステータス管理

### ステータスの種類と遷移

**ステータス一覧**：
- **Proposed**: 提案中（初期状態）
- **Accepted**: 承認済み（実装可能）
- **Deprecated**: 非推奨（新しい方法が推奨される）
- **Superseded**: 置き換え済み（新しいADRで上書き）

**ステータス遷移ルール**：
1. **Proposed → Accepted**: レビューと承認完了時
2. **Accepted → Deprecated**: より良い方法が見つかったが、既存実装は残す場合
3. **Accepted → Superseded**: 新しいADRで完全に置き換える場合
4. **Deprecated → Superseded**: 非推奨から完全に置き換える場合

### ADRの更新とバージョン管理

**更新が必要なケース**：
- 実装中に重要な変更が発生した場合
- 実装後に想定外の影響が判明した場合
- より良い解決策が見つかった場合

**バージョン管理方法**：
- ADRファイル内に更新履歴セクションを設ける
- 重大な変更の場合は新しいADRを作成し、古いADRをSupersededに
- 軽微な変更は既存ADRを更新し、更新内容を記録

## Design Documentとの使い分け

### ADR（Architecture Decision Record）

- **目的**: なぜその決定をしたかを記録
- **内容**: 決定事項、根拠、トレードオフ
- **タイミング**: 重要な技術的決定時
- **読者**: 将来の開発者、意思決定者

### Design Document

- **目的**: どのように実装するかを記録
- **内容**: 詳細設計、実装計画、テスト戦略
- **タイミング**: 複雑な機能の実装前
- **読者**: 実装担当者、レビュアー

## ベストプラクティス

### 1. 早期の文書化

- 議論の段階からドラフトを作成
- 決定を下す前に選択肢を文書化

### 2. 簡潔で明確な記述

- 技術的な正確性を保ちつつ、理解しやすく
- 具体例やコードサンプルを活用

### 3. 継続的な更新

- 実装後の学びを反映
- 古くなったADRは"Superseded"に更新

### 4. チーム全体での共有

- 重要な決定は全員に周知
- 定期的なADRレビュー会の実施

## AI（Claude）利用時の特別ルール

AIがコード変更を行う際は、以下のルールが適用されます：

1. **事前確認の徹底**
   - 5ファイル以上の変更が予想される場合、実装前にADR作成を提案
   - 型定義やデータフローの変更時は必ずユーザーに確認

2. **既存ADRの確認**
   - 関連機能の変更前に、該当するADRを必ず読み込み
   - ADRが存在しない場合はその旨を報告

3. **段階的アプローチ**
   - 大きな変更は小さなステップに分割
   - 各ステップでの影響を明確に説明

## 緊急時の例外プロセス

### 緊急対応が必要なケース

以下の状況では、通常のADRプロセスを簡略化できます：

1. **本番環境の重大な障害対応**
2. **セキュリティ脆弱性の緊急修正**
3. **データ損失リスクがある問題の対応**

### 緊急時のプロセス

1. **即座の対応実施**: 問題解決を最優先
2. **簡易記録作成**: 対応内容と理由を簡潔に記録
3. **事後ADR作成**: 48時間以内に正式なADRを作成
4. **レトロスペクティブ**: 緊急対応の振り返りと改善

### 緊急対応の判断基準

- ビジネスへの影響度: High/Critical
- 対応緊急度: 24時間以内の対応が必要
- 代替手段: 一時的な回避策では不十分
