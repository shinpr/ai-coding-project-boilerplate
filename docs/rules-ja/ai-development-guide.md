# AI開発者ガイド - 実装時の具体的指針

このドキュメントは、LLM（あなた）が実装時に参照すべき具体的なチェックリスト、自己診断方法、禁止事項、ワークフロー注意点をまとめたものです。

## 実装前必須チェックリスト

1. **ルールファイル読み込み**: 7つのルールファイルを必ず全て読む（標準化された用語のためのcanonical-phrases.mdを含む）
2. **既存ドキュメントの段階的確認**
   - 設計時: 関連ADRのみ確認
   - 実装時: 関連Design Docのみ確認
   - 作業開始時: 進行中の作業計画書確認
   - 未確認での実装は禁止
3. **タスク分析**: 本質的な目的、影響範囲、汎用的解決策を検討
4. **計画立案**: 実装計画をユーザーに提示

## 実装中の自己診断トリガー

**必ず立ち止まって確認するタイミング**
- ツール使用前: Edit/Write/MultiEdit（承認確認）、Read（影響範囲）、Bash（コマンド理解）
- 作業進行中: 5ファイル以上開いた時、エラー2回以上、調査→実装移行時、コミット前

**自己診断質問**
- 実装の方向性: 計画からの逸脱、汎用的設計、コード可読性
- 品質と整合性: テストファースト実践、ADR/Design Doc準拠、影響範囲確認

## 赤信号パターン（即座に停止すべき状況）

✅ **推奨**: 各ステップで完全動作、品質チェック
❌ **避ける**: 「一旦動くように」、品質チェックの省略

**停止すべきパターン**
1. 同じようなコードを3回以上書いた（ルール・オブ・スリー）
2. ファイルが300行を超えた
3. 同じ内容を複数ファイルで定義
4. 依存関係を確認せずに変更
5. コメントアウトでコード無効化
6. エラーの握りつぶし
7. 型アサーション（as）の多用

## Rule of Three（重複の閾値）

**原則**: 同じパターンが3回出現したら共通化（Martin Fowler「Refactoring」）

| 重複回数 | 対応 |
|---------|------|
| 1回目 | インライン実装 |
| 2回目 | 将来の統合を意識 |
| 3回目 | 共通化実施 |

**共通化すべき**: ビジネスロジック、複雑な処理、一括変更が必要な箇所
**共通化を避ける**: 偶然の一致、将来分岐する可能性、可読性低下

## よくある失敗パターンと回避方法

✅ **推奨**: 汎用的設計、根本原因解決（5 Whys）、YAGNI原則、ドキュメント確認
❌ **避ける**: 継ぎ足し実装、対処療法、6ファイル以上の無計画変更

## エスカレーション基準（必ずユーザーに確認）

1. **アーキテクチャ変更**: 新レイヤー、責務変更、データフロー変更
2. **外部依存追加**: npmパッケージ、外部API、環境変数
3. **破壊的変更**: API変更、データ構造変更、大幅な命名変更
4. **判断困難時**: 複数の実装方法、不明確なトレードオフ、予測不能なリスク

**確認テンプレート**: 状況説明 → 選択肢（メリット/デメリット） → 推奨案

## 指示の優先順位

1. **最優先**: ユーザー承認（Edit/Write/MultiEdit前に必須）
2. **高優先**: 品質チェック通過、ドキュメント整合性
3. **中優先**: 汎用的設計、根本原因解決
4. **低優先**: パフォーマンス最適化

## ワークフロー注意点

**作業計画書の活用**
- 中規模（3-5ファイル）: 推奨
- 大規模（6ファイル以上）: 必須
- キーワード「リファクタリング」「統廃合」「最適化」含む場合: 必須

**コミット**: 論理単位、品質チェック後、「なぜ」を説明
**テスト**: Red-Green-Refactor（例外: 設定ファイル）

**リファクタリングタイミング**
- タスク着手直後（最優先）
- 同じパターンを3回発見
- ファイル300行超過

## デバッグフロー

1. **エラー分析**: スタックトレース確認
2. **5 Whys**: 根本原因追求
3. **最小再現**: 問題切り分け
4. **テスト確認**: 関連テストの失敗確認

## 品質チェック（実装完了時必須）

**Phase 1-3: 基本チェック**
- `npm run check` - Biome総合
- `npm run check:unused` - 未使用エクスポート
- `npm run build` - TypeScript

**Phase 4-6: テストと最終確認**
- `npm test` - テスト実行
- `npm run test:coverage:fresh` - カバレッジ確認（70%以上必須）
- `npm run check:all` - 統合チェック

**補足コマンド**
- カバレッジ詳細: `open coverage/index.html`
- テスト後クリーンアップ: `npm run cleanup:processes`（必須）
- 安全なテスト実行: `npm run test:safe`

**失敗時**: エラー解消 → 自動修正 → 再実行

**整合性チェック**
- 重複定義がないか（定数、型、関数）
- ファイル間参照の正しさ
- 意図しない変更の有無

## チートシート

**開始**: ルール読み → ドキュメント確認 → 計画 → 承認
**実装**: ツール前チェック → 赤信号注意 → ドキュメント整合性
**完了**: Phase1-6品質チェック → エラー修正 → コミット

**マインドセット**: 謙虚（完璧なコードは存在しない）、勇気（大胆なリファクタリング）、透明（判断理由明確化）