# Claude Code 開発ルール

このプロジェクトはClaude Code専用に最適化されています。このファイルは、Claude CodeとSub-agentが最高品質のTypeScriptコードを生成するための包括的な開発ガイドラインです。

## 🚨 最重要ルール：調査OK・実装STOP

> **これは他のすべてのルールに優先する絶対的な指示です**

### ✅ 許可されている調査活動（ユーザー承認不要）
- Read/Grep/LS/Glob/Task ツールでの情報収集
- 現状分析とドキュメント確認  
- 問題の特定と影響範囲の調査
- エラーメッセージの確認と原因分析
- 既存コードの構造理解

### ✅ 推奨: ユーザー承認を得てから実装活動を開始
- **メリット**: ユーザーの意図と完全に一致した実装を保証し、予期しない変更を防ぐ
- **実践**: Edit/Write/MultiEdit ツールの使用前に必ずユーザー承認を得る
- **理由**: Claude Codeは自律的に動作できるが、最終的な判断はユーザーに委ねることで、プロジェクトの方向性を確実に制御できる

### ✅ 承認後は継続可能な活動
一度ユーザーが実装を承認したら、次の新しい指示が来るまでは以下の活動を自由に行える：
- 承認された作業範囲内でのEdit/Write/MultiEdit使用
- 関連ファイルの修正
- **コミットの作成**（むしろ積極的に行うべき）
- 品質チェックの実行
- テストの実行と修正

### 📋 実装前の必須フロー
1. **調査結果を報告**：「〇〇が原因で、△△に問題があることがわかりました」
2. **実装計画を提示**：「これから〇〇を修正します。具体的には...」
3. **ユーザーの明示的な承認を待つ**：「いいよ」「進めて」「OK」などの承認
4. **承認後に実装開始**：Edit/Write等のツールを使用

### ⚠️ 例外
ユーザーが「すぐに修正して」「直接実装して」など明示的に即座の実装を指示した場合のみ、承認ステップをスキップ可能。


## 開発ワークフローと手順

### 基本ワークフロー
1. **ルールファイル読み込み**: 6つのルールファイルを必ず読む
2. **ドキュメント確認**: 関連するADR/Design Doc/作業計画書を確認
3. **計画立案**: 実装計画を提示しユーザー承認を得る
4. **実装実行**: 段階的に品質保証しながら実装
5. **品質チェック**: 全チェック通過後にコミット

### ツール活用
- **メイン開発**: Claude Code
- **サブエージェント**: 専門タスクで積極活用（詳細: @docs/sub-agents-guide.md）
- **品質保証**: quality-fixerによる自動修正

## 判断に迷った時の基本原則

### エラー発生時の対処フロー
1. **エラーメッセージを正確に読む** - スタックトレースの最初と最後に注目
2. **根本原因を分析** - 「なぜ？」を5回繰り返す（5 Whys）
3. **影響範囲を確認** - 他のファイルや機能への影響を調査
4. **解決策を複数検討** - 最低2つ以上の解決方法を考える
5. **不明な場合はユーザーに確認** - 推測で進めず、必ず確認を取る

### 判断の優先順位
実装時に複数の原則が衝突した場合の優先順位：
1. **ユーザー承認** > すべて（最優先）
2. **品質保証** > 実装速度
3. **根本解決** > 一時的対処
4. **明確さ** > 簡潔さ
5. **保守性** > パフォーマンス（明確なボトルネックがない限り）

### エスカレーション基準（必ずユーザーに確認）
以下の場合は、実装前に必ずユーザーの判断を仰ぐ：
- **アーキテクチャレベルの変更** - 新レイヤー追加、責務変更、データフロー変更
- **外部依存の追加** - 新npmパッケージ、新API、新環境変数
- **破壊的変更** - 既存API変更、データ構造変更、大幅な命名変更
- **トレードオフが不明確** - 複数の実装方法で優劣が判断できない
- **影響範囲が5ファイル以上** - 大規模変更は必ず事前承認

詳細なエスカレーション基準は @docs/rules/ai-development-guide.md を参照。

## 開発ルールファイル

このプロジェクトの開発ガイドラインは `docs/rules/` ディレクトリ内のルールファイルで管理されています。すべてのClaude AIツールはこれらのルールを厳守する必要があります。

@docs/rules/technical-spec.md
@docs/rules/typescript.md
@docs/rules/typescript-testing.md
@docs/rules/project-context.md
@docs/rules/ai-development-guide.md
@docs/rules/architecture-decision-process.md

## 【絶対厳守】初回必須タスク

> ⚠️ **警告**: 以下は絶対に守らなければならない最重要ルールです

### タスクを受け取った際の手順

1. **実装停止**: コード修正前に必ず停止
2. **ルールファイル読み込み**: 6つのルールファイルを全て読む
3. **関連ドキュメント確認**: ADR/Design Doc/作業計画書を確認  
4. **計画立案**: 実装計画を提示
5. **ユーザー承認**: 承認後に実装開始

**重要**: ドキュメント未確認での実装は絶対禁止

### アーキテクチャ遵守
詳細は @docs/rules/technical-spec.md を参照。

### 一時ファイル管理
- 作業中ファイルは`tmp/`ディレクトリに作成
- 作業完了時に削除
- 永続化が必要なもののみ適切な場所に配置

## タスク管理の原則

### 基本方針
- **各タスクは完全に完結**: 品質保証済みの動作する状態で完了
- **独立性の確保**: 相互依存のない単位に分解
- **コミット可能粒度**: 1タスク = 1つの論理的変更単位

### 詳細手順
タスク分解基準、実行フロー、品質保証については @docs/rules/ai-development-guide.md を参照。

### エスカレーション基準
詳細については @docs/rules/ai-development-guide.md の「エスカレーション基準」を参照。

### 実装前の確認プロセス

**必須確認事項**:
1. 関連ドキュメント確認（ADR/Design Doc/作業計画書）
2. 既存コードとテストの理解
3. 影響範囲の把握

**効率的な確認手順**:
- 設計・計画時: 関連するADRのみ確認
- 実装時: 関連するDesign Docのみ確認
- 作業開始時: 進行中の作業計画書を確認

**設計承認フロー**: ドキュメント作成 → レビュー → 承認 → 実装開始

**重要**: ドキュメント未確認での実装着手は重大なルール違反

## 開発プロセスの基本原則

### 実装前の計画と合意
変更規模に応じた計画立案については @docs/rules/technical-spec.md の「PRD/ADR/Design Doc/作業計画書作成プロセス」を参照。

**基本フロー**: 計画提示 → ユーザー承認 → 実装開始

### テストファースト開発
詳細については @docs/rules/typescript-testing.md の「Red-Green-Refactorプロセス」を参照。

**基本原則**: 新機能・バグ修正はテストから始める

### 根本原因分析
詳細については @docs/rules/ai-development-guide.md を参照。

### 重要な設計原則

**基本方針**:
- YAGNI原則の徹底
- 各ステップで品質保証済みの完全な実装
- 不要なコードは削除（コメントアウト禁止）

**⚠️ 段階的実装の警告**:
- **禁止**: 「一旦動くように」「後で修正」「移行期間中は両方保持」
- **必須**: 各ステップで完全に動作し、品質保証済みの実装

**詳細については以下を参照**:
- リファクタリング原則: @docs/rules/typescript.md
- 品質保証プロセス: @docs/rules/ai-development-guide.md

## 作業計画書の運用

作業計画書の作成基準、命名規則、運用フローなどの詳細については @docs/rules/technical-spec.md の「作業計画書について」を参照。

### Claude Code向けの追加ガイドライン
- **TodoWriteで3つ以上のタスクを作成した場合**: 計画書作成を検討
- **「調査」「分析」タスクの次**: 必ず「計画書作成/更新」タスクを追加
- **計画書なしで調査を開始してしまった場合**: 即座に停止して計画書を作成

## コード品質チェック（必須）

### 基本原則
- **ゼロエラー原則**: 警告・エラーを一切残さない
- **完了条件**: 全チェックがエラーなしで通ること

品質チェックの詳細については @docs/rules/ai-development-guide.md の「品質チェック（実装完了時必須）」を参照。

**重要**: すべてのチェックがエラーなしで通らない限り、作業は完了とみなさない。

## プロジェクトテンプレートとしての特性

### プロジェクトの背景
- **プロジェクトタイプ**: Claude Code専用TypeScriptプロジェクトテンプレート
- **主要ユーザー**: Claude Codeを使用するTypeScript開発者
- **テンプレートの特性**: LLM研究に基づく科学的根拠のあるルールセット
- **開発体制**: Claude Code主導の開発、ユーザーが最終的な意思決定を行う
- **ルール準拠**: プロジェクトコンテキストの適切な解釈と実装

### Claude Codeとしての行動原則
1. **実装者としての責任**: コード実装の全責任を負い、品質を保証
2. **承認者への敬意**: ユーザーは最終的な承認者として尊重
3. **透明性の確保**: 実装内容と意図を明確に説明し、判断材料を提供
4. **適切な抽象化**: 重複削除の判断基準に従い、過度な抽象化を避けつつ保守性を高める
5. **サブエージェント活用**: 専門的なタスクは積極的にサブエージェントに委譲

### 開発指針
コード重複の判断基準とリファクタリング手法については @docs/rules/typescript.md を参照。

## 注意事項

- この設定により、すべてのClaude AIツールが一貫した開発プラクティスを維持
- `docs/rules/` 内のすべてのルールファイルはコーディング標準として権威的に扱う
- 迷った場合は、既存のコードで確立されたパターンに従う
- **推奨: ルールファイルの完全理解がClaude Codeの最高パフォーマンスの前提条件** - ルールを理解することで、プロジェクトに最適な実装を実現