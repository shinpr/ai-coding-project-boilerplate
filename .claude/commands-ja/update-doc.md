---
description: 既存設計ドキュメント（Design Doc / PRD / ADR）をレビュー付きで更新
---

**コマンドコンテキスト**: このコマンドは既存設計ドキュメントの更新専用です。

## オーケストレーター定義

**コアアイデンティティ**: 「私は作業者ではない。オーケストレーターである。」（subagents-orchestration-guideスキル参照）

**初期アクション**: 実行前にステップ1-6をTodoWriteに登録する。

**実行プロトコル**:
1. **全作業をサブエージェントに委譲**（自分でドキュメントを編集しない）
2. **更新フローを実行**:
   - 対象特定 → 変更内容確認 → ドキュメント更新 → レビュー → 整合性チェック
   - **`[停止: ...]`マーカーで必ず停止** → 次に進む前にユーザー承認を待つ
3. **スコープ**: 更新されたドキュメントが承認されたら完了

**重要**: document-reviewerと停止ポイントは必ず実行する。

## ワークフロー概要

```
対象ドキュメント → [停止: 変更内容確認]
                        ↓
              technical-designer / prd-creator（updateモード）
                        ↓
              document-reviewer → [停止: レビュー承認]
                        ↓（Design Docのみ）
              design-sync → [停止: 最終承認]
```

## スコープ境界

**実行内容**:
- 既存ドキュメントの特定と選択
- ユーザーとの変更内容確認
- 適切なエージェントによるドキュメント更新（updateモード）
- document-reviewerによるドキュメントレビュー
- design-syncによる整合性検証（Design Docのみ）

**実行しない**:
- 新規要件分析（新規ドキュメントには/designを使用）
- 作業計画や実装（本コマンド後に/planまたは/taskを使用）

**責務境界**: このコマンドは更新されたドキュメントの承認で責務完了。

対象ドキュメント: $ARGUMENTS

## 実行フロー

### ステップ1: 対象ドキュメントの特定

```bash
# 既存ドキュメントを確認
ls docs/design/*.md docs/prd/*.md docs/adr/*.md 2>/dev/null | grep -v template
```

**判断フロー**:

| 状況 | アクション |
|------|-----------|
| $ARGUMENTSがパスを指定 | 指定ドキュメントを使用 |
| $ARGUMENTSがトピックを記述 | トピックに合致するドキュメントを検索 |
| 複数の候補が見つかった | AskUserQuestionで選択肢を提示 |
| ドキュメントが見つからない | 報告して終了（代わりに/designを推奨） |

### ステップ2: ドキュメントタイプの判定

ドキュメントパスからタイプを判定:

| パスパターン | タイプ | 更新エージェント | 備考 |
|-------------|--------|-----------------|------|
| `docs/design/*.md` | Design Doc | technical-designer | - |
| `docs/prd/*.md` | PRD | prd-creator | - |
| `docs/adr/*.md` | ADR | technical-designer | 軽微な変更: 既存ファイルを更新、大きな変更: 元を置き換える新ADRを作成 |

**ADR更新ガイダンス**:
- **軽微な変更**（明確化、誤字修正、小規模なスコープ調整）: 既存ADRファイルを更新
- **大きな変更**（決定の変更、大規模なスコープ変更）: 元のADRを置き換える新しいADRを作成

### ステップ3: 変更内容の確認 [停止]

AskUserQuestionで必要な変更を確認:
- どのセクションの更新が必要か
- 変更の理由（バグ修正の発見、仕様変更、レビューフィードバック等）
- 更新後の期待される結果

変更内容の理解をユーザーと確認してから進む。

### ステップ4: ドキュメント更新

ステップ2で決定した更新エージェントを呼び出す:
```
subagent_type: [ステップ2の更新エージェント]
description: "[ステップ2のタイプ]を更新"
prompt: |
  動作モード: update
  既存ドキュメント: [ステップ1のパス]

  ## 必要な変更
  [ステップ3で確認した変更内容]

  指定された変更を反映するようドキュメントを更新する。
  変更履歴エントリを追加する。
```

### ステップ5: ドキュメントレビュー [停止]

document-reviewerを呼び出す:
```
subagent_type: document-reviewer
description: "更新されたドキュメントをレビュー"
prompt: |
  以下の更新されたドキュメントをレビューする。

  doc_type: [Design Doc / PRD / ADR]
  target: [ステップ1のパス]
  mode: standard

  注力ポイント:
  - 更新セクションとドキュメント全体の整合性
  - 変更による矛盾が発生していないこと
  - 変更履歴の完全性
```

**レビュー結果に基づく対応**:
- 承認 → ステップ6へ進む
- 要修正 → レビュアーフィードバックを持ってステップ4に戻る（最大2回）
- **2回のリジェクト後** → 人間レビュー用にフラグ、蓄積されたフィードバックをユーザーに提示して終了

レビュー結果をユーザーに提示して承認を得る。

### ステップ6: 整合性検証（Design Docのみ） [停止]

**スキップ条件**: ドキュメントタイプがPRDまたはADR → 完了へ進む。

Design Docの場合、design-syncを呼び出す:
```
subagent_type: design-sync
description: "整合性を検証"
prompt: |
  更新されたDesign Docと他の設計ドキュメントとの整合性を検証する。

  更新されたドキュメント: [ステップ1のパス]
```

**整合性結果に基づく対応**:
- 矛盾なし → 結果をユーザーに提示して最終承認を得る
- 矛盾を検出 → AskUserQuestionで矛盾をユーザーに提示:
  - A: このドキュメントの矛盾を解決するためステップ4に戻る
  - B: コマンドを終了し、矛盾は別途対応する

## エラーハンドリング

| エラー | アクション |
|--------|-----------|
| 対象ドキュメントが見つからない | 報告して終了（代わりに/designを推奨） |
| サブエージェントの更新が失敗 | 失敗をログ、エラーをユーザーに提示、1回リトライ |
| 2回の修正後もレビューがリジェクト | ループを停止、人間介入用にフラグ |
| design-syncが矛盾を検出 | 解決判断のためユーザーに提示 |

## 完了条件

- [ ] 対象ドキュメントを特定した
- [ ] ユーザーと変更内容を確認した
- [ ] 適切なエージェントでドキュメントを更新した（updateモード）
- [ ] document-reviewerを実行しフィードバックに対応した
- [ ] design-syncで整合性検証を実行した（Design Docのみ）
- [ ] 更新されたドキュメントのユーザー承認を取得した

## 出力例
ドキュメント更新が完了しました。
- 更新されたドキュメント: docs/design/[ドキュメント名].md
- 承認ステータス: ユーザー承認済み

**重要**: 本コマンドはドキュメント承認で終了。次フェーズへの移行提案は行わない。
