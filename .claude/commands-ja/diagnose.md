---
description: 問題を調査し、検証を経て解決策を導出する
---

**コマンドコンテキスト**: 問題の根本原因を特定し、解決策を提示するための診断フロー

対象問題: $ARGUMENTS

**TodoWrite登録**: 実行ステップをTodoWriteに登録し、計画的にタスクを進める

## ステップ0: 問題の構造化（investigator呼び出し前）

### 0.1 問題タイプの判定

| タイプ | 判断基準 |
|--------|---------|
| 変更失敗 | 問題発生の前に何らかの変更があったことが示唆されている |
| 新規発見 | 変更との関連が示唆されていない |

判断に迷う場合は「問題発生の直前に何か変更しましたか？」とユーザーに確認。

### 0.2 変更失敗の場合の情報補完

以下が不明な場合、**AskUserQuestionで質問**してから次に進む：
- 何を変更したか（原因変更）
- 何が壊れたか（影響箇所）
- 両者の関係（共通コンポーネント等）

### 0.3 investigatorプロンプトへの反映

**変更失敗の場合、以下を必須調査項目としてプロンプトに含める**：
1. 原因変更の内容を詳細に分析
2. 原因変更と影響箇所の共通点を特定
3. 原因変更が正しい修正か新たなバグかを判定し、判定結果に基づいて比較基準を選択

## 診断フロー概要

```
問題 → 調査 → 品質判定 → [検証] → 解決策導出
                    ↓
               単純な場合は
               検証スキップ
```

**コンテキスト分離**: 各ステップには構造化JSON出力のみを渡す。思考過程は引き継がない。

## 実行ステップ

以下をTodoWriteに登録して実行：

### ステップ1: 調査（investigator）

**Taskツールでの呼び出し**:
```
subagent_type: investigator
prompt: 以下の現象について、関連する情報を網羅的に収集してください。

現象: [ユーザーが報告した問題]
```

**期待される出力**: 証拠マトリクス、比較分析結果、因果追跡結果、未探索領域のリスト、調査の限界

### ステップ2: 品質判定・検証判断

調査出力を確認し判定：

**調査品質チェック**（出力JSONに以下が含まれているか）:
- [ ] comparisonAnalysis
- [ ] 各仮説にcausalChain（停止条件に到達）
- [ ] 各仮説にcauseCategory

**品質不足の場合**: 不足項目を指定して調査を再実行

**検証実行条件（1つでも該当）**:
- 2つ以上の仮説が同程度の証拠を持つ
- 直接証拠がなく間接証拠のみ
- 未探索領域が2つ以上ある
- 仮説に反証する証拠が存在する
- 問題が過去に再発している
- impactAnalysis.impactScopeに3件以上の該当箇所がある
- impactAnalysis.recurrenceRiskがhigh

**検証スキップ条件（すべて該当）**:
- 1つの仮説が明らかに優勢（直接証拠あり、反証なし）
- 未探索領域がほぼない
- 単発の問題（再発履歴なし）

判定結果をユーザーに報告し、検証をスキップする場合は理由を説明。

### ステップ3: 検証（verifier）※複雑な問題の場合

**Taskツールでの呼び出し**:
```
subagent_type: verifier
prompt: 以下の調査結果を検証してください。

調査結果: [調査のJSON出力]
```

**期待される出力**: 代替仮説（最低3つ）、Devil's Advocate評価、最終結論、信頼度

### ステップ4: 解決策導出（solver）

**Taskツールでの呼び出し**:
```
subagent_type: solver
prompt: 以下の検証済み結論に基づいて、解決策を導出してください。

結論: [検証または調査の結論部分]
信頼度: [high/medium/low]
```

**期待される出力**: 複数の解決策（最低3つ）、トレードオフ分析、推奨案と実装ステップ

### ステップ5: 最終レポート作成

診断完了後、以下の形式でユーザーに報告：

```
## 診断結果サマリー

### 特定された原因
[検証結果の結論]
信頼度: [high/medium/low]

### 検証プロセス
- 調査範囲: [調査で確認した範囲]
- 検証実施: [はい/いいえ]
- 代替仮説数: [検証で生成した数]

### 推奨する解決策
[解決策導出の推奨案]

理由: [選定理由]

### 実装ステップ
1. [ステップ1]
2. [ステップ2]
...

### 代替案
[代替案の説明]

### 残る不確実性
- [不確実性1]
- [不確実性2]

### 解決後の確認事項
- [確認事項1]
- [確認事項2]
```

## 完了条件

- [ ] 調査を実行し、証拠マトリクス・比較分析・因果追跡を取得した
- [ ] 調査品質チェックを行い、不足があれば再実行した
- [ ] 検証判断を行い、結果をユーザーに報告した
- [ ] （複雑な場合）検証を実行した
- [ ] 解決策導出を実行した
- [ ] 最終レポートをユーザーに提示した
