---
description: 問題を調査し、検証を経て解決策を導出する
---

**コマンドコンテキスト**: 問題の根本原因を特定し、解決策を提示するための診断フロー

対象問題: $ARGUMENTS

**Role**: オーケストレーター

**実行方法**:
- 調査 → investigatorに委譲
- 検証 → verifierに委譲
- 解決策導出 → solverに委譲

オーケストレーターがサブエージェントを呼び出し、構造化JSONを受け渡します。

**TodoWrite登録**: 実行ステップをTodoWriteに登録し、計画的にタスクを進める

## ステップ0: 問題の構造化（investigator呼び出し前）

### 0.1 問題タイプの判定

| タイプ | 判断基準 |
|--------|---------|
| 変更失敗 | 問題発生の前に何らかの変更があったことが示唆されている |
| 新規発見 | 変更との関連が示唆されていない |

判断に迷う場合は「問題発生の直前に何か変更しましたか？」とユーザーに確認。

### 0.2 変更失敗の場合の情報補完

以下が不明な場合、**AskUserQuestionで質問**してから次に進む：
- 何を変更したか（原因変更）
- 何が壊れたか（影響箇所）
- 両者の関係（共通コンポーネント等）

### 0.3 問題の本質理解

Taskツールでrule-advisorを呼び出す:
- `subagent_type`: "rule-advisor"
- `description`: "問題の本質特定"
- `prompt`: "以下の問題について、本質と必要なスキルを特定してください: [ユーザーが報告した問題]"

rule-advisorの出力から以下を確認：
- `taskAnalysis.mainFocus`: 問題の主要な焦点
- `mandatoryChecks.taskEssence`: 表面的な症状でなく根本的な問題
- `selectedSkills`: 適用すべきスキルセクション
- `warningPatterns`: 回避すべきパターン

### 0.4 investigatorプロンプトへの反映

**以下をinvestigatorプロンプトに含める**：
1. 問題の本質（taskEssence）
2. 適用すべきスキルの要約（selectedSkillsから重要なセクション）
3. 調査観点（investigationFocus）: warningPatternsを「この問題の調査で混同・見落としやすいポイント」に変換したもの
4. **変更失敗の場合、追加で以下を含める**：
   - 原因変更の内容を詳細に分析
   - 原因変更と影響箇所の共通点を特定
   - 原因変更が正しい修正か新たなバグかを判定し、判定結果に基づいて比較基準を選択

## 診断フロー概要

```
問題 → investigator → verifier → solver ─┐
                 ↑                        │
                 └── 信頼度high未達 ──────┘
                      (最大2回)

信頼度high達成 → レポート
```

**コンテキスト分離**: 各ステップには構造化JSON出力のみを渡す。思考過程は引き継がない。

## 実行ステップ

以下をTodoWriteに登録して実行：

### ステップ1: 調査（investigator）

Taskツールでinvestigatorを呼び出す:
- `subagent_type`: "investigator"
- `description`: "問題情報の収集"
- `prompt`: "以下の現象について、関連する情報を網羅的に収集してください。現象: [ユーザーが報告した問題]"

**期待される出力**: 証拠マトリクス、比較分析結果、因果追跡結果、未探索領域のリスト、調査の限界

### ステップ2: 調査品質判定

調査出力を確認：

**品質チェック**（出力JSONに以下が含まれているか）:
- [ ] comparisonAnalysis
- [ ] 各仮説にcausalChain（停止条件に到達）
- [ ] 各仮説にcauseCategory
- [ ] investigationFocusに対応する調査が含まれているか（渡された場合）

**品質不足の場合**: 不足項目を指定してinvestigatorを再実行

**design_gap検出時のエスカレーション**:

investigatorの出力で`causeCategory: design_gap`または`recurrenceRisk: high`の場合：
1. verifier実行前に**ユーザー確認を挿入**
2. AskUserQuestionで以下を確認：
   「設計レベルの問題が検出されました。以下のどちらで進めますか？」
   - A: 現状の設計内で修正を試みる
   - B: 設計の見直しを含めて検討する
3. ユーザーがBを選択した場合、solverに`includeRedesign: true`を渡す

品質を満たしたらverifierに進む。

### ステップ3: 検証（verifier）

Taskツールでverifierを呼び出す:
- `subagent_type`: "verifier"
- `description`: "調査結果の検証"
- `prompt`: "以下の調査結果を検証してください。調査結果: [調査のJSON出力]"

**期待される出力**: 代替仮説（最低3つ）、Devil's Advocate評価、最終結論、信頼度

**信頼度の判定基準**:
- **high**: 解決策の選択・実装に影響する不確実性がない
- **medium**: 不確実性があるが、追加調査で解消可能
- **low**: 根本的な情報不足がある

### ステップ4: 解決策導出（solver）

Taskツールでsolverを呼び出す:
- `subagent_type`: "solver"
- `description`: "解決策の導出"
- `prompt`: "以下の検証済み結論に基づいて、解決策を導出してください。原因: [verifierのconclusion.causes]。原因の関係性: [causesRelationship: independent/dependent/exclusive]。信頼度: [high/medium/low]"

**期待される出力**: 複数の解決策（最低3つ）、トレードオフ分析、推奨案と実装ステップ、残存リスク

**完了条件**: 信頼度がhigh

**未達の場合**:
1. solverが特定した不確実性を調査対象としてステップ1に戻る
2. 追加調査は最大2回まで
3. 2回の追加調査後も未達の場合、ユーザーに選択肢を提示：
   - 追加調査を継続
   - 現在の信頼度で解決策を実行

### ステップ5: 最終レポート作成

**前提**: 信頼度highを達成している

診断完了後、以下の形式でユーザーに報告：

```
## 診断結果サマリー

### 特定された原因
[検証結果の原因リスト]
- 原因の関係性: [independent/dependent/exclusive]

### 検証プロセス
- 調査範囲: [調査で確認した範囲]
- 追加調査回数: [0/1/2回]
- 代替仮説数: [検証で生成した数]

### 推奨する解決策
[解決策導出の推奨案]

理由: [選定理由]

### 実装ステップ
1. [ステップ1]
2. [ステップ2]
...

### 代替案
[代替案の説明]

### 残存リスク
[solverのresidualRisks]

### 解決後の確認事項
- [確認事項1]
- [確認事項2]
```

## 完了条件

- [ ] investigatorを実行し、証拠マトリクス・比較分析・因果追跡を取得した
- [ ] 調査品質チェックを行い、不足があれば再実行した
- [ ] verifierを実行し、信頼度を取得した
- [ ] solverを実行した
- [ ] 信頼度highを達成した（または2回の追加調査後にユーザー承認を得た）
- [ ] 最終レポートをユーザーに提示した
