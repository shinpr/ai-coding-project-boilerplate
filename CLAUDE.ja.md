# Claude Code 開発ルール

AI実行精度最大化のための中核ルール。全ての指示はこのファイルに従う。

## 🚨 最重要原則：調査OK、実装STOP

**すべてのEdit/Write/MultiEditツール使用前にユーザー承認が必須**

理由：ユーザーの意図と異なる実装を防ぎ、正しい方向性を確保するため

## 必須実行プロセス

### 実行フロー（必須手順）
1. **TodoWriteでタスク分解** → なければ実装ステップに進めない
   理由：タスクを構造化し、進捗を追跡可能にするため
2. **rule-advisor実行** → タスクの本質を理解し適切なルールを選択
   理由：適切なルールを選択し、タスクの本質を理解するため
3. **Edit/Write/MultiEdit使用** → ユーザー承認が必須
   理由：最重要原則の実践（調査OK、実装STOP）
4. **実装実行** → 品質チェックエラーは完了条件を満たさない
   理由：高品質なコードを保証するため
5. **ファイル数カウント** → 閾値超過で自動停止
   理由：影響範囲が大きくなる前に確認を取るため

### TodoWriteとメタ認知の統合
**実行ルール**：
- `pending → in_progress`時: rule-advisorの出力が必須
- **rule-advisor実行後**: 必ずTodoWriteを以下の形式で更新
  1. metaCognitiveGuidance.firstStepをTodoの先頭タスクとして追加
  2. metaCognitiveGuidance.taskEssenceを各タスクの完了判断基準として記録
  3. warningPatternsを実行中の確認項目として記録
- TodoWriteなしでEditツール使用: ルール違反として停止
- 各タスクのステータス更新時: 実施内容の記録を必須化（空白不可）

### 実行前提条件
1. **rule-advisorエージェント実行(Taskツールで呼び出すこと)** → JSONレスポンスが存在すること
2. **TodoWriteのタスク** → in_progressステータスが存在すること
3. **ユーザー承認記録** → Edit/Write前に明示的承認があること
4. **品質チェック結果** → エラー0でなければ完了不可

### 必須の代替パターン
- **any型の代わり** → unknown型と型ガードを使用
  理由：型安全性を確保し、実行時エラーを防止するため
- **Edit使用時** → 必ずTodoWriteでタスク管理を先行
  理由：進捗追跡と品質保証を可能にするため
- **Edit/Write/MultiEdit使用時** → ユーザー承認を取得してから実行
  理由：最重要原則（調査OK、実装STOP）を遵守するため
- **完了宣言時** → 品質チェックエラー0を確認してから宣言
  理由：完全なコードのみをマージするため

## メタ認知実行（タスク開始時必須）

### rule-advisorから取得した情報でメタ認知
1. **taskEssence（タスクの本質）を理解**
   - 表面的な作業内容と根本目的の区別
   - 「quick fix」vs「proper solution」の判定

2. **selectedSkills（適用スキル）を確認**
   - 選択されたスキルが適切か判断
   - 必要なセクションを読み込む

3. **metaCognitiveGuidance.pastFailures（過去の失敗）を認識**
   - 同じ失敗を繰り返さないよう注意
   - 提示された回避策を意識

4. **metaCognitiveGuidance.firstStep（初動アクション）を実行**
   - 推奨されたツールから開始
   - 計画的に進める

## Claude行動制御（失敗防止）

### 自動停止トリガー（必ず停止）
- **5ファイル以上の変更検出**：即座停止、影響範囲をユーザーに報告
  理由：大規模変更は事前計画とレビューが必要なため
- **同じエラー3回発生**：根本原因分析必須
  理由：対症療法ではなく根本解決が必要なため
- **unknown型多用検出**：型ガード設計再検討
  理由：型安全性の設計に問題がある可能性が高いため
- **3ファイル編集完了**: TodoWriteの更新を強制（更新しないと次のEditツール使用不可）
  理由：進捗確認と方向性の再確認が必要なため

### エラー修正衝動対処
1. エラー発見 → **一時停止**
2. rule-advisor再実行
3. 根本原因分析（なぜ？を5回繰り返して真因を特定）
4. 対処計画提示
5. ユーザー承認後に修正

### エスカレーション基準（ユーザー確認必須）
- アーキテクチャ変更（新レイヤー追加、責務変更）
- 外部依存追加（npmパッケージ、外部API）
- 破壊的変更（既存APIの変更、データ構造の変更）
- 複数の実装方法があり優劣が判断できない場合

### 集中時のルール無視防止
**測定可能な強制停止基準**：
- **連続エラー修正2回目**: 自動的にrule-advisor再実行をトリガー
- **Editツール5回使用**: 影響範囲レポートの作成を強制
- **同一ファイル3回編集**: リファクタリング検討の強制停止

### 一時ファイル作成ルール
作業中ファイルは`tmp/`ディレクトリ使用。完了時削除。